<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Merge Word Files — MergeWise</title>

  <!-- Bootstrap 5 CDN (responsive UI) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --accent:#0d6efd;
      --muted:#6c757d;
      --card-bg:#ffffff;
      --page-bg:#f5f8fb;
    }
    body{background:var(--page-bg);min-height:100vh;display:flex;flex-direction:column}

    /* Header */
    header.site-header{background:linear-gradient(90deg,#0d6efd22,#6c757d11);border-bottom:1px solid rgba(0,0,0,0.04)}
    .brand{font-weight:700;letter-spacing:0.2px}

    /* Main card */
    .upload-card{max-width:960px;margin:28px auto;padding:24px;border-radius:12px;box-shadow:0 6px 30px rgba(18,38,63,0.06);background:var(--card-bg)}

    /* Drag & drop area */
    .dropzone{border:2px dashed rgba(13,110,253,0.18);border-radius:10px;padding:28px;text-align:center;transition:all .15s}
    .dropzone.dragover{background:#eef5ff;border-color:rgba(13,110,253,0.45);transform:translateY(-2px)}
    .dropzone small{color:var(--muted)}

    /* file list */
    .file-item{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-radius:8px;background:#fbfcff;border:1px solid #eef3ff;margin-bottom:8px}
    .file-meta{display:flex;gap:12px;align-items:center}
    .file-name{font-weight:600}

    /* footer */
    footer.site-footer{margin-top:auto;padding:20px 0;background:transparent;text-align:center;color:var(--muted)}

    /* Responsive small tweaks */
    @media (max-width:575px){
      .upload-card{margin:12px;padding:16px}
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header py-3">
    <div class="container d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-3">
        <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%230d6efd'><path d='M3 3h18v18H3z' opacity='0.05'/><path d='M7 7h10v10H7z'/></svg>" alt="logo" width="36" height="36">
        <div>
          <div class="brand">MergeWise</div>
          <small class="text-muted">Merge .docx files — preserve headers, footers & formatting</small>
        </div>
      </div>
      <nav class="d-none d-md-block">
        <a class="me-3 text-decoration-none" href="#how">How it works</a>
        <a class="me-3 text-decoration-none" href="#options">Options</a>
        <a class="btn btn-outline-primary btn-sm" href="#">No login • Free</a>
      </nav>
    </div>
  </header>

  <!-- Main -->
  <main class="container">
    <div class="upload-card">
      <div class="row g-4">
        <div class="col-12 col-lg-7">
          <h4 class="mb-2">Upload Word files to merge</h4>
          <p class="text-muted">Drag & drop or click to pick multiple <strong>.docx</strong> files. Each file will start on a new page and keep its own header/footer (Word COM recommended).</p>

          <div id="dropzone" class="dropzone" tabindex="0">
            <svg width="44" height="44" viewBox="0 0 24 24" fill="none" aria-hidden>
              <path d="M12 3v9" stroke="#0d6efd" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="#0d6efd" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <div class="mt-2">Drop Word files here or <button id="browseBtn" class="btn btn-link p-0">browse</button></div>
            <small class="d-block mt-2">Supports multiple .docx files. Recommended: 2–20 files, any size (server limits apply).</small>
            <input id="fileInput" type="file" name="files" accept=".docx" multiple hidden>
          </div>

          <div class="mt-3">
            <h6 class="mb-2">Files to merge</h6>
            <div id="fileList" aria-live="polite"></div>
          </div>

          <div class="mt-3 d-flex gap-2 flex-wrap" id="options">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="1" id="optPreserveHeaders" checked>
              <label class="form-check-label" for="optPreserveHeaders">Preserve headers/footers (recommended)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="1" id="optAddSeparator" checked>
              <label class="form-check-label" for="optAddSeparator">Add visible separator between files</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" value="1" id="optUniformPage" >
              <label class="form-check-label" for="optUniformPage">Force uniform page size/margins</label>
            </div>
          </div>

          <div class="mt-4 d-flex gap-2 align-items-center">
            <button id="mergeBtn" class="btn btn-primary">Merge Files</button>
            <div id="status" class="text-muted small"></div>
          </div>

          <div class="mt-3">
            <div class="progress" style="height:10px;display:none" id="progressWrap">
              <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%"></div>
            </div>
            <div id="messageArea" class="mt-2 small text-muted"></div>
          </div>
        </div>

        <div class="col-12 col-lg-5">
          <div class="p-3" style="background:#fbfdff;border-radius:8px;min-height:220px">
            <h6 class="mb-2">Tips & status</h6>
            <ul class="small text-muted">
              <li>Best results on Windows with Microsoft Word installed — the server will use Word COM to preserve headers exactly.</li>
              <li>If Word COM isn't available, a fallback is used (docxcompose). In most cases this works, but very complex docs may differ.</li>
              <li>We never require login. Files are processed temporarily and removed after merging.</li>
            </ul>

            <hr>
            <h6 class="mb-2">Example workflow</h6>
            <ol class="small text-muted">
              <li>Pick your .docx files (order matters).</li>
              <li>Click <strong>Merge Files</strong>.</li>
              <li>Download the merged file when ready.</li>
            </ol>
          </div>
        </div>
      </div>
    </div>

    <!-- How it works section -->
    <section id="how" class="mb-5">
      <div class="container">
        <div class="row">
          <div class="col-md-8 mx-auto text-center small text-muted">
            <p>MergeWise stitches .docx files together. Each uploaded document will start on a new page. Headers/footers will be preserved per-document when the server has Microsoft Word available. Use the options to change behavior.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Footer -->
  <footer class="site-footer">
    <div class="container py-3">
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3">
        <div>
          <strong>MergeWise</strong> • Merge .docx files • No login
        </div>
        <div class="small text-muted">Built for local use. Uploaded files are removed after processing.</div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // UI logic: drag/drop, file list, and uploading to /merge
    const fileInput = document.getElementById('fileInput');
    const dropzone = document.getElementById('dropzone');
    const fileList = document.getElementById('fileList');
    const browseBtn = document.getElementById('browseBtn');
    const mergeBtn = document.getElementById('mergeBtn');
    const status = document.getElementById('status');
    const progressWrap = document.getElementById('progressWrap');
    const progressBar = document.getElementById('progressBar');
    const messageArea = document.getElementById('messageArea');

    let files = [];

    function renderFileList(){
      fileList.innerHTML = '';
      if(files.length === 0){
        fileList.innerHTML = '<div class="text-muted">No files selected</div>';
        return;
      }
      files.forEach((f, idx) => {
        const div = document.createElement('div');
        div.className = 'file-item';
        div.innerHTML = `
          <div class="file-meta">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden>
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="#0d6efd" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"></path>
              <path d="M14 2v6h6" stroke="#0d6efd" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <div>
              <div class="file-name">${f.name}</div>
              <div class="small text-muted">${(f.size/1024).toFixed(1)} KB</div>
            </div>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-danger" data-idx="${idx}">Remove</button>
          </div>
        `;
        fileList.appendChild(div);
      });

      // remove handlers
      fileList.querySelectorAll('button[data-idx]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const idx = Number(e.currentTarget.dataset.idx);
          files.splice(idx,1);
          renderFileList();
        });
      });
    }

    function handleFiles(selected){
      const allowed = ['application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
      for(const f of Array.from(selected)){
        if(!allowed.includes(f.type) && !f.name.toLowerCase().endsWith('.docx')){
          messageArea.innerText = 'Only .docx files are allowed';
          continue;
        }
        files.push(f);
      }
      renderFileList();
    }

    browseBtn.addEventListener('click', (e)=>{ e.preventDefault(); fileInput.click(); });
    fileInput.addEventListener('change', (e)=>{ handleFiles(e.target.files); fileInput.value = ''; });

    // Drag/drop
    ['dragenter','dragover'].forEach(ev => dropzone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover'); }));
    ['dragleave','drop'].forEach(ev => dropzone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover'); }));
    dropzone.addEventListener('drop', (e)=>{
      if(e.dataTransfer && e.dataTransfer.files) handleFiles(e.dataTransfer.files);
    });

    // Merge action
    mergeBtn.addEventListener('click', async ()=>{
      if(files.length < 1){ messageArea.innerText = 'Please select at least one .docx file'; return; }

      mergeBtn.disabled = true; status.innerText = 'Uploading...'; progressWrap.style.display = 'block'; progressBar.style.width = '10%';
      messageArea.innerText = '';

      const form = new FormData();
      for(const f of files) form.append('files', f, f.name);
      // options
      form.append('preserve_headers', document.getElementById('optPreserveHeaders').checked ? '1' : '0');
      form.append('add_separator', document.getElementById('optAddSeparator').checked ? '1' : '0');
      form.append('uniform_page', document.getElementById('optUniformPage').checked ? '1' : '0');

      try{
        const resp = await fetch('/merge', { method:'POST', body: form });
        if(!resp.ok) throw new Error('Server error: ' + resp.statusText);

        // progress -> simulate
        progressBar.style.width = '60%'; status.innerText = 'Merging on server...';

        const blob = await resp.blob();
        progressBar.style.width = '95%'; status.innerText = 'Preparing download...';

        // auto-download with suggested filename
        const dlName = 'merged_output.docx';
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = dlName; document.body.appendChild(a); a.click(); a.remove();
        window.URL.revokeObjectURL(url);

        status.innerText = 'Done'; progressBar.style.width = '100%';
      }catch(err){
        console.error(err);
        messageArea.innerText = err.message || 'Upload failed';
        status.innerText = 'Error';
      }finally{
        mergeBtn.disabled = false; setTimeout(()=>{ progressWrap.style.display='none'; progressBar.style.width='0%'; }, 1500);
      }
    });

    // initial
    renderFileList();
  </script>
</body>
</html>
